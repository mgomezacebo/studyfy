<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studyfy - Carpeta</title>
    <link rel="icon" type="image/png" href="../logos/icono.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/docx@8.0.1/build/index.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'duo-green': '#58cc02',
                        'duo-orange': '#ff9600',
                        'duo-blue': '#1cb0f6',
                        'duo-purple': '#ce82ff',
                        'duo-red': '#ff4b4b',
                        'duo-yellow': '#ffc800',
                        'duo-text-dark': '#4b4b4b',
                        'duo-text-white': '#ffffff',
                        'duo-text-green': '#58cc02'
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                        'roboto': ['Roboto', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        
        .popup-overlay { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .popup-content { animation: popupSlide 0.3s ease-out; }
        @keyframes popupSlide { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Lists inside apuntes content */
        #apuntes-content ul { list-style: disc; margin-left: 1.5rem; padding-left: 0.5rem; }
        #apuntes-content ol { list-style: decimal; margin-left: 1.5rem; padding-left: 0.5rem; }
        #apuntes-content li { margin-bottom: 0.25rem; }
    </style>
    <script src="../acceso/guard-sesion.js" defer></script>
</head>
<body class="font-roboto bg-gray-50 min-h-screen pb-20">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="goBack()" class="text-duo-text-dark hover:text-duo-text-green">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 id="folder-title" class="font-poppins font-bold text-xl text-duo-text-green">Carpeta</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="exportFolderContent()" class="text-duo-text-dark hover:text-duo-text-green">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <div id="folder-content">
            <!-- Content will be loaded here -->
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex justify-around py-3">
                <button onclick="goToHome()" class="flex flex-col items-center space-y-1 text-duo-text-dark">
                    <div class="text-2xl">üìÅ</div>
                    <span class="text-xs font-medium">Inicio</span>
                </button>
                <button onclick="goToCalendar()" class="flex flex-col items-center space-y-1 text-duo-text-dark">
                    <div class="text-2xl">üìÖ</div>
                    <span class="text-xs font-medium">Calendario</span>
                </button>
                <button onclick="goToStats()" class="flex flex-col items-center space-y-1 text-duo-text-dark">
                    <div class="text-2xl">üìä</div>
                    <span class="text-xs font-medium">Estad√≠sticas</span>
                </button>
                <button onclick="goToChat()" class="flex flex-col items-center space-y-1 text-duo-text-dark">
                    <div class="text-2xl">ü§ñ</div>
                    <span class="text-xs font-medium">Chatbot</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Content Player Popup -->
    <div id="content-player" class="popup-overlay fixed inset-0 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="popup-content bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div id="player-content">
                    <!-- Content will be loaded here -->
                </div>
                <button onclick="closeContentPlayer()" class="w-full mt-4 py-2 px-4 bg-duo-text-dark text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentFolder = null;
        let currentContent = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadFolderData();
        });

        // Custom alert function
        function showCustomAlert(message) {
            const alertPopup = document.createElement('div');
            alertPopup.className = 'popup-overlay fixed inset-0 z-50 flex items-center justify-center';
            alertPopup.innerHTML = `
                <div class="popup-content bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚ÑπÔ∏è</div>
                        <p class="font-poppins font-medium text-duo-text-dark mb-6">${message}</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">
                            Aceptar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertPopup);
            
            // Close on background click
            alertPopup.addEventListener('click', (e) => {
                if (e.target === alertPopup) {
                    alertPopup.remove();
                }
            });
        }

        // Custom prompt function
        function showCustomPrompt(message, defaultValue, callback) {
            const promptPopup = document.createElement('div');
            promptPopup.className = 'popup-overlay fixed inset-0 z-50 flex items-center justify-center';
            promptPopup.innerHTML = `
                <div class="popup-content bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚úèÔ∏è</div>
                        <p class="font-poppins font-medium text-duo-text-dark mb-4">${message}</p>
                        <input type="text" id="custom-prompt-input" value="${defaultValue}" class="w-full p-3 border border-gray-300 rounded-lg mb-4 font-roboto">
                        <div class="flex space-x-3">
                            <button onclick="submitCustomPrompt()" class="flex-1 bg-duo-green text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors">
                                Aceptar
                            </button>
                            <button onclick="closeCustomPrompt()" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-duo-text-dark hover:bg-gray-50 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(promptPopup);
            window.customPromptCallback = callback;
            setTimeout(() => document.getElementById('custom-prompt-input').focus(), 50);
            promptPopup.addEventListener('click', (e) => { if (e.target === promptPopup) closeCustomPrompt(); });
        }

        function submitCustomPrompt() {
            const input = document.getElementById('custom-prompt-input');
            const value = input.value;
            if (window.customPromptCallback) window.customPromptCallback(value);
            closeCustomPrompt();
        }

        function closeCustomPrompt() {
            const popup = document.querySelector('.popup-overlay');
            if (popup) popup.remove();
            window.customPromptCallback = null;
        }

        // Custom confirm function
        function showCustomConfirm(message, callback) {
            const existing = document.getElementById('confirm-popup-overlay');
            if (existing) existing.remove();
            const confirmPopup = document.createElement('div');
            confirmPopup.id = 'confirm-popup-overlay';
            confirmPopup.className = 'popup-overlay fixed inset-0 z-50 flex items-center justify-center';
            confirmPopup.innerHTML = `
                <div class="popup-content bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <p class="font-poppins font-medium text-duo-text-dark mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button onclick="submitCustomConfirm()" class="flex-1 bg-duo-red text-white py-2 px-4 rounded-lg font-medium hover:bg-red-600 transition-colors">
                                Eliminar
                            </button>
                            <button onclick="closeCustomConfirm()" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-duo-text-dark hover:bg-gray-50 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmPopup);
            window.customConfirmCallback = callback;
            confirmPopup.addEventListener('click', (e) => { if (e.target === confirmPopup) closeCustomConfirm(); });
        }

        function submitCustomConfirm() {
            if (window.customConfirmCallback) {
                window.customConfirmCallback();
            }
            closeCustomConfirm();
        }

        function closeCustomConfirm() {
            const popup = document.getElementById('confirm-popup-overlay');
            if (popup) popup.remove();
            window.customConfirmCallback = null;
        }

        // Load folder data from URL params
        function loadFolderData() {
            const urlParams = new URLSearchParams(window.location.search);
            const folderId = urlParams.get('id');
            
            if (!folderId) {
                goBack();
                return;
            }

            const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
            currentFolder = appData.folders?.find(f => f.id === folderId);
            
            if (!currentFolder) {
                goBack();
                return;
            }

            document.getElementById('folder-title').textContent = currentFolder.name;
            displayFolderContents();
        }

        // Display folder contents
        function displayFolderContents() {
            const container = document.getElementById('folder-content');
            
            if (!currentFolder.contents || currentFolder.contents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-duo-text-dark">
                        <div class="text-6xl mb-4">üìö</div>
                        <p class="font-poppins font-medium text-lg mb-2">Esta carpeta est√° vac√≠a</p>
                        <p class="text-sm mb-6">Importa contenido para empezar a estudiar</p>
                        <button onclick="goToHome()" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">
                            Ir al Inicio
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="mb-6">
                    <h2 class="font-poppins font-semibold text-xl text-duo-text-dark mb-4">
                        Contenidos (${currentFolder.contents.length})
                    </h2>
                </div>
                <div class="grid gap-4">
                    ${currentFolder.contents.map(content => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover-lift">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 cursor-pointer" onclick="openContent('${content.id}')">
                                    <div class="text-2xl">${getContentIcon(content.type)}</div>
                                    <div>
                                        <h4 class="font-poppins font-semibold text-duo-text-dark">${content.title}</h4>
                                        <p class="text-sm text-gray-500">${getContentTypeName(content.type)} ‚Ä¢ ${formatDate(content.importedAt)}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="text-duo-text-dark hover:text-duo-text-green" title="Renombrar" onclick="event.stopPropagation(); renameContent('${content.id}')">‚úèÔ∏è</button>
                                    <button class="text-duo-text-dark hover:text-duo-text-green" title="Exportar" onclick="event.stopPropagation(); exportSingleContent('${content.id}')">üì§</button>
                                    <button class="text-duo-text-green hover:text-green-700" title="Abrir" onclick="event.stopPropagation(); openContent('${content.id}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    </button>
                                    <button class="text-duo-red hover:text-red-700" title="Eliminar" onclick="event.stopPropagation(); deleteContent('${content.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Get content icon based on type
        function getContentIcon(type) {
            const icons = {
                'apuntes': 'üìù',
                'test': '‚ùì',
                'flashcards': 'üóÇÔ∏è',
                'ejercicios': '‚úèÔ∏è',
                'default': 'üìÑ'
            };
            return icons[type] || icons.default;
        }

        // Get content type name
        function getContentTypeName(type) {
            const names = {
                'apuntes': 'Apuntes',
                'test': 'Test de Pr√°ctica',
                'flashcards': 'Flash Cards',
                'ejercicios': 'Ejercicios',
                'default': 'Contenido'
            };
            return names[type] || names.default;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        // Open content player
        function openContent(contentId) {
            currentContent = currentFolder.contents.find(c => c.id === contentId);
            if (!currentContent) return;

            const player = document.getElementById('content-player');
            const contentDiv = document.getElementById('player-content');
            
            contentDiv.innerHTML = generateContentHTML(currentContent);
            player.classList.remove('hidden');
            
            // Agregar funcionalidad de cerrarse al hacer clic fuera
            player.addEventListener('click', (e) => {
                if (e.target === player) {
                    closeContentPlayer();
                }
            });
        }

        // Close content player
        function closeContentPlayer() {
            document.getElementById('content-player').classList.add('hidden');
            currentContent = null;
        }

        // Generate content HTML based on type
        function generateContentHTML(content) {
            const { type, data, title } = content;
            
            switch (type) {
                case 'apuntes':
                    return generateApuntesHTML(data, title);
                case 'test':
                    return generateTestHTML(data, title);
                case 'flashcards':
                    return generateFlashcardsHTML(data, title);
                case 'ejercicios':
                    return generateEjerciciosHTML(data, title);
                default:
                    return generateDefaultHTML(data, title);
            }
        }

        // Generate Apuntes HTML
        function generateApuntesHTML(data, title) {
            const html = typeof data.content === 'string' ? marked.parse(data.content) : formatApuntesContent(data.content);
            return `
                <div class="mb-4">
                    <h3 class="font-poppins font-bold text-xl text-duo-text-green mb-4">${title}</h3>
                    <div class="prose max-w-none" id="apuntes-content">
                        ${html}
                    </div>
                </div>
                <div class="flex justify-center">
                    <button onclick="downloadApuntes('${title}')" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">
                        üì• Descargar en DOCX
                    </button>
                </div>
            `;
        }

        // Generate Test HTML
        function generateTestHTML(data, title) {
            window.__testState = { index: 0, total: data.questions.length, questions: data.questions, correct: 0 };
            return `
                <div class="mb-4">
                    <h3 class="font-poppins font-bold text-xl text-duo-text-green mb-4">${title}</h3>
                    <div id="test-container">
                        ${generateTestQuestion(data.questions[0], 0, data.questions.length)}
                    </div>
                </div>
            `;
        }

        // Generate Flashcards HTML
        function generateFlashcardsHTML(data, title) {
            window.__flashState = { index: 0, total: data.cards.length, cards: data.cards, known: [], unknown: [] };
            return `
                <div class="mb-4">
                    <h3 class="font-poppins font-bold text-xl text-duo-text-green mb-4">${title}</h3>
                    <div id="flashcard-container">
                        ${generateFlashcard(data.cards[0], 0, data.cards.length)}
                    </div>
                </div>
            `;
        }

        // Generate Ejercicios HTML
        function generateEjerciciosHTML(data, title) {
            const ejercicios = data.ejercicios || [];
            return `
                <div class="mb-4">
                    <h3 class="font-poppins font-bold text-xl text-duo-text-green mb-4">${title}</h3>
                    <div id="ejercicios-container" class="space-y-6">
                        ${ejercicios.map((e, i) => `
                            <div class="p-4 border border-gray-200 rounded-lg bg-white">
                                <div class="mb-2"><span class="text-sm text-gray-500">Ejercicio ${i+1}</span></div>
                                <p class="font-poppins font-medium text-duo-text-dark mb-3">${e.pregunta}</p>
                                <textarea id="respuesta-${i}" class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none" placeholder="Escribe tu respuesta..."></textarea>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex flex-wrap gap-3 justify-center">
                        <button onclick="exportEjerciciosDOCX('${title}', false)" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">üì• DOCX con respuestas</button>
                        <button onclick="exportEjerciciosDOCX('${title}', true)" class="bg-duo-blue text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-600 transition-colors">üìÑ DOCX en blanco</button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-duo-text-dark">Puntuaci√≥n (%)</label>
                            <input id="ejercicios-score" type="number" min="0" max="100" class="w-20 p-2 border border-gray-300 rounded-lg">
                            <button onclick="saveEjerciciosScore()" class="bg-duo-orange text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-600 transition-colors">Guardar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate Default HTML
        function generateDefaultHTML(data, title) {
            return `
                <div class="mb-4">
                    <h3 class="font-poppins font-bold text-xl text-duo-text-green mb-4">${title}</h3>
                    <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        // Format apuntes content (basic formatting)
        function formatApuntesContent(content) {
            if (typeof content === 'string') {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/__(.*?)__/g, '<u>$1</u>')
                    .replace(/\n/g, '<br>');
            }
            return JSON.stringify(content);
        }

        // Generate test question
        function generateTestQuestion(question, currentIndex, total) {
            if (!question) return '<p>No hay preguntas disponibles</p>';
            
            const options = shuffleArray([...question.options]);
            
            return `
                <div class="mb-6">
                    <div class="mb-4">
                        <span class="text-sm text-gray-500">Pregunta ${currentIndex + 1} de ${total}</span>
                        <h4 class="font-poppins font-semibold text-lg text-duo-text-dark mt-2">${question.question}</h4>
                    </div>
                    <div class="space-y-3">
                        ${options.map((option, index) => `
                            <button onclick="checkAnswer('${option.replace(/'/g, "&#39;")}', '${question.correct.replace(/'/g, "&#39;")}', ${currentIndex}, ${total})" 
                                    class="w-full text-left p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Generate flashcard
        function generateFlashcard(card, currentIndex, total) {
            if (!card) return '<p>No hay tarjetas disponibles</p>';
            
            return `
                <div class="mb-6">
                    <div class="mb-4 flex items-center justify-between">
                        <span class="text-sm text-gray-500">Tarjeta ${currentIndex + 1} de ${total}</span>
                        <div class="space-x-2">
                            <button onclick="prevFlashcard(${currentIndex})" class="py-1 px-3 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Anterior</button>
                            <button onclick="toggleFlashcardAnswer()" class="py-1 px-3 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Mostrar</button>
                        </div>
                    </div>
                    <div id="flashcard-question" class="mb-4">
                        <h4 class="font-poppins font-semibold text-lg text-duo-text-dark">${card.question}</h4>
                    </div>
                    <div id="flashcard-answer" class="mb-4 hidden">
                        <h4 class="font-poppins font-semibold text-lg text-duo-text-green">Respuesta:</h4>
                        <p class="text-duo-text-dark">${card.answer}</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="markFlashcard(true, ${currentIndex}, ${total})" class="bg-duo-green text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors">‚úîÔ∏è Me la s√©</button>
                        <button onclick="markFlashcard(false, ${currentIndex}, ${total})" class="bg-duo-red text-white py-2 px-4 rounded-lg font-medium hover:bg-red-600 transition-colors">‚ùå No me la s√©</button>
                    </div>
                </div>
            `;
        }

        // Generate ejercicio
        function generateEjercicio(ejercicio, currentIndex, total) {
            if (!ejercicio) return '<p>No hay ejercicios disponibles</p>';
            
            return `
                <div class="mb-6">
                    <div class="mb-4">
                        <span class="text-sm text-gray-500">Ejercicio ${currentIndex + 1} de ${total}</span>
                        <h4 class="font-poppins font-semibold text-lg text-duo-text-dark mt-2">${ejercicio.pregunta}</h4>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-duo-text-dark mb-2">Tu respuesta:</label>
                        <textarea id="respuesta-${currentIndex}" placeholder="Escribe tu respuesta aqu√≠..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none"></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="previousEjercicio(${currentIndex})" ${currentIndex === 0 ? 'disabled' : ''} 
                                class="bg-gray-400 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50">
                            Anterior
                        </button>
                        <button onclick="nextEjercicio(${currentIndex}, ${total})" 
                                class="bg-duo-green text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors">
                            ${currentIndex === total - 1 ? 'Finalizar' : 'Siguiente'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Test functions
        function checkAnswer(selected, correct, currentIndex, total) {
            const isCorrect = selected === correct;

            // update state
            if (!window.__testState) window.__testState = { index: currentIndex, total, questions: [], correct: 0 };
            if (isCorrect) {
                window.__testState.correct += 1;
            }

            // Marcar visualmente las opciones seleccionadas
            markSelectedOption(selected, correct, isCorrect);
            
            // Reproducir sonido seg√∫n si es correcto o incorrecto
            if (isCorrect) {
                playSound('correcto');
            } else {
                // Para respuestas incorrectas, usar el mismo sonido pero con volumen reducido
                const audio = new Audio(`../sonidos/correcto.mp3`);
                audio.volume = 0.5; // Reducir volumen para distinguir respuestas incorrectas
                audio.play().catch(()=>{});
            }
            
            // Mostrar mensaje de resultado (no pop-up)
            if (isCorrect) {
                showCorrectMessage();
            } else {
                showIncorrectMessage(correct);
            }

            // Avanzar a la siguiente pregunta despu√©s de un delay
            setTimeout(() => {
                advanceToNextQuestion(currentIndex, total);
            }, 2000); // 2 segundos para que el usuario vea el mensaje
        }

        function markSelectedOption(selected, correct, isCorrect) {
            // Obtener todos los botones de opciones
            const buttons = document.querySelectorAll('#test-container button');
            
            buttons.forEach(button => {
                const buttonText = button.textContent.replace(/^[A-Z]\.\s/, ''); // Remover "A. ", "B. ", etc.
                
                if (buttonText === selected) {
                    // Marcar la opci√≥n seleccionada
                    if (isCorrect) {
                        button.style.backgroundColor = '#10b981'; // bg-green-500
                        button.style.color = '#ffffff'; // text-white
                        button.style.borderColor = '#059669'; // border-green-600
                        button.classList.remove('hover:bg-gray-50', 'border-gray-300');
                    } else {
                        button.style.backgroundColor = '#ef4444'; // bg-red-500
                        button.style.color = '#ffffff'; // text-white
                        button.style.borderColor = '#dc2626'; // border-red-600
                        button.classList.remove('hover:bg-gray-50', 'border-gray-300');
                    }
                } else if (buttonText === correct && !isCorrect) {
                    // Marcar la respuesta correcta si la seleccionada era incorrecta
                    button.style.backgroundColor = '#10b981'; // bg-green-500
                    button.style.color = '#ffffff'; // text-white
                    button.style.borderColor = '#059669'; // border-green-600
                    button.classList.remove('hover:bg-gray-50', 'border-gray-300');
                }
                
                // Deshabilitar todos los botones
                button.disabled = true;
                button.style.pointerEvents = 'none';
            });
        }

        function advanceToNextQuestion(currentIndex, total) {
            const nextIndex = currentIndex + 1;
            const container = document.getElementById('test-container');
            
            // Limpiar mensaje anterior si existe
            const existingMessage = document.getElementById('answer-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            if (nextIndex < total) {
                window.__testState.index = nextIndex;
                const q = window.__testState.questions?.[nextIndex] || null;
                const question = q || { ...window.__testState.questions };
                container.innerHTML = generateTestQuestion(window.__testState.questions ? window.__testState.questions[nextIndex] : null, nextIndex, total);
            } else {
                const score = Math.round((window.__testState.correct / total) * 100);
                container.innerHTML = `
                    <div class="text-center p-6 bg-gray-50 rounded-xl">
                        <div class="text-4xl mb-3">‚úÖ</div>
                        <p class="font-poppins font-semibold text-duo-text-dark mb-1">Test finalizado</p>
                        <p class="text-sm text-gray-500">Puntuaci√≥n: ${score}% (${window.__testState.correct}/${total} correctas)</p>
                        <div class="mt-4">
                            <button onclick="closeContentPlayer()" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                saveTestResult(score, total, window.__testState.correct);
            }
        }

        function showCorrectMessage() {
            // Crear mensaje de respuesta correcta en un recuadro verde
            const messageDiv = document.createElement('div');
            messageDiv.id = 'answer-message';
            messageDiv.className = 'mt-4 p-4 bg-green-100 border border-green-300 rounded-lg text-green-800 text-center';
            messageDiv.innerHTML = `
                <div class="text-2xl mb-2">‚úÖ</div>
                <p class="font-poppins font-semibold">¬°Correcto! üéâ</p>
            `;
            
            // Insertar el mensaje despu√©s del contenedor de opciones
            const optionsContainer = document.querySelector('#test-container .space-y-3');
            if (optionsContainer) {
                optionsContainer.parentNode.insertBefore(messageDiv, optionsContainer.nextSibling);
            }
        }

        function showIncorrectMessage(correct) {
            // Crear mensaje de respuesta incorrecta en un recuadro rojo
            const messageDiv = document.createElement('div');
            messageDiv.id = 'answer-message';
            messageDiv.className = 'mt-4 p-4 bg-red-100 border border-red-300 rounded-lg text-red-800 text-center';
            messageDiv.innerHTML = `
                <div class="text-2xl mb-2">‚ùå</div>
                <p class="font-poppins font-semibold">Incorrecto</p>
                <p class="text-sm mt-1">La respuesta correcta es: <strong>${correct}</strong></p>
            `;
            
            // Insertar el mensaje despu√©s del contenedor de opciones
            const optionsContainer = document.querySelector('#test-container .space-y-3');
            if (optionsContainer) {
                optionsContainer.parentNode.insertBefore(messageDiv, optionsContainer.nextSibling);
            }
        }

        function playSound(filename) {
            const audio = new Audio(`../sonidos/${filename}.mp3`);
            audio.play().catch(()=>{});
        }

        // Flashcard functions
        function toggleFlashcardAnswer() {
            const answer = document.getElementById('flashcard-answer');
            const button = event.target;
            
            if (answer.classList.contains('hidden')) {
                answer.classList.remove('hidden');
                button.textContent = 'Mostrar Pregunta';
            } else {
                answer.classList.add('hidden');
                button.textContent = 'Mostrar Respuesta';
            }
        }

        function markFlashcard(knows, currentIndex, total) {
            if (!window.__flashState) return;
            const card = window.__flashState.cards[currentIndex];
            if (knows) {
                window.__flashState.known.push(card);
            } else {
                window.__flashState.unknown.push(card);
            }
            nextFlashcard(currentIndex, total);
        }

        function nextFlashcard(currentIndex, total) {
            if (!window.__flashState) return;
            const next = currentIndex + 1;
            if (next < total) {
                window.__flashState.index = next;
                document.getElementById('flashcard-container').innerHTML = generateFlashcard(window.__flashState.cards[next], next, total);
            } else {
                showFlashcardStats();
            }
        }

        function prevFlashcard(currentIndex) {
            if (!window.__flashState) return;
            const prev = currentIndex - 1;
            if (prev >= 0) {
                window.__flashState.index = prev;
                document.getElementById('flashcard-container').innerHTML = generateFlashcard(window.__flashState.cards[prev], prev, window.__flashState.total);
            }
        }

        function showFlashcardStats() {
            const total = window.__flashState?.total || 0;
            const known = window.__flashState?.known.length || 0;
            const unknown = window.__flashState?.unknown.length || 0;
            const percent = total ? Math.round((known / total) * 100) : 0;
            document.getElementById('flashcard-container').innerHTML = `
                <div class="text-center p-6 bg-gray-50 rounded-xl">
                    <div class="text-4xl mb-3">üìä</div>
                    <p class="font-poppins font-semibold text-duo-text-dark mb-1">Resumen de Flashcards</p>
                    <p class="text-sm text-gray-500 mb-4">Conocidas: ${known}/${total} (${percent}%) ‚Ä¢ Por repasar: ${unknown}</p>
                    <div class="flex justify-center">
                        <button onclick="closeContentPlayer()" class="bg-duo-green text-white py-2 px-6 rounded-lg font-medium hover:bg-green-600 transition-colors">Cerrar</button>
                    </div>
                </div>
            `;
            saveFlashcardStats(total, known);
        }

        // Ejercicios functions
        function nextEjercicio(currentIndex, total) {
            if (currentIndex < total - 1) {
                // TODO: Navigate to next ejercicio
                showCustomAlert('Navegando al siguiente ejercicio...');
            } else {
                showEjerciciosOptions();
            }
        }

        function previousEjercicio(currentIndex) {
            if (currentIndex > 0) {
                // TODO: Navigate to previous ejercicio
                showCustomAlert('Navegando al ejercicio anterior...');
            }
        }

        function showEjerciciosOptions() {
            // TODO: Show options for exporting answers
            showCustomAlert('Mostrando opciones de exportaci√≥n...');
        }

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function saveTestResult(score, total, correct) {
            const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
            if (!appData.stats) appData.stats = { tests: [], exercises: [], flashcards: [] };
            appData.stats.tests.push({ score, total, correct, date: new Date().toISOString(), title: currentContent?.title || 'Test' });
            localStorage.setItem('duostudy-data', JSON.stringify(appData));
        }

        function saveFlashcardStats(total, known) {
            const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
            if (!appData.stats) appData.stats = { tests: [], exercises: [], flashcards: [] };
            
            const percentage = total > 0 ? Math.round((known / total) * 100) : 0;
            
            appData.stats.flashcards.push({ 
                total, 
                known, 
                unknown: total - known,
                percentage: percentage,
                date: new Date().toISOString(), 
                setTitle: currentContent?.title || 'Flashcards' 
            });
            localStorage.setItem('duostudy-data', JSON.stringify(appData));
        }

        async function exportEjerciciosDOCX(title, blankOnly = false) {
            const container = document.getElementById('ejercicios-container');
            const blocks = Array.from(container.querySelectorAll('div.p-4'));
            const { Document, Packer, Paragraph, TextRun } = docx;
            
            const children = [];
            blocks.forEach((block, idx) => {
                const q = block.querySelector('p').innerText;
                const a = block.querySelector('textarea').value;
                
                children.push(new Paragraph({ children: [ new TextRun({ text: `Ejercicio ${idx+1}`, bold: true }) ] }));
                children.push(new Paragraph({ children: [ new TextRun(q) ] }));
                if (!blankOnly) {
                    children.push(new Paragraph({ children: [ new TextRun(`Respuesta: ${a}`) ] }));
                }
                children.push(new Paragraph({ children: [ new TextRun('') ] }));
                children.push(new Paragraph({ children: [ new TextRun('') ] }));
            });
            
            const doc = new Document({ sections: [{ properties: {}, children }] });
            const blob = await Packer.toBlob(doc);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${title}${blankOnly ? '-en-blanco' : ''}.docx`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function saveEjerciciosScore() {
            const score = parseInt(document.getElementById('ejercicios-score').value, 10);
            if (isNaN(score)) { showCustomAlert('Introduce un porcentaje v√°lido.'); return; }
            const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
            if (!appData.stats) appData.stats = { tests: [], exercises: [], flashcards: [] };
            appData.stats.exercises.push({ score, date: new Date().toISOString(), title: currentContent?.title || 'Ejercicios' });
            localStorage.setItem('duostudy-data', JSON.stringify(appData));
            showCustomAlert('Puntuaci√≥n guardada');
        }

        function renameContent(contentId) {
            const content = currentFolder.contents.find(c => c.id === contentId);
            if (!content) return;
            showCustomPrompt('Nuevo t√≠tulo del contenido:', content.title, (newTitle) => {
                if (!newTitle || !newTitle.trim()) return;
                content.title = newTitle.trim();
                const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
                const folder = appData.folders?.find(f => f.id === currentFolder.id);
                if (folder) {
                    const item = folder.contents.find(c => c.id === contentId);
                    if (item) item.title = content.title;
                    localStorage.setItem('duostudy-data', JSON.stringify(appData));
                }
                displayFolderContents();
            });
        }

        function exportSingleContent(contentId) {
            const content = currentFolder.contents.find(c => c.id === contentId);
            if (!content) return;
            const dataStr = JSON.stringify(content, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${content.title || 'contenido'}.json`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        function deleteContent(contentId) {
            showCustomConfirm('¬øEst√°s seguro de que quieres eliminar este contenido?', () => {
                currentFolder.contents = currentFolder.contents.filter(c => c.id !== contentId);
                const appData = JSON.parse(localStorage.getItem('studyfy-data') || '{}');
                const folder = appData.folders?.find(f => f.id === currentFolder.id);
                if (folder) {
                    folder.contents = folder.contents.filter(c => c.id !== contentId);
                    localStorage.setItem('duostudy-data', JSON.stringify(appData));
                }
                displayFolderContents();
                showCustomAlert('Contenido eliminado exitosamente');
            });
        }

        async function downloadApuntes(title) {
            const contentDiv = document.getElementById('apuntes-content');
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            const children = [];
            
            if (contentDiv) {
                // Process HTML content to preserve formatting
                const elements = contentDiv.children;
                for (let element of elements) {
                    if (element.tagName === 'H1') {
                        children.push(new Paragraph({ 
                            text: element.textContent, 
                            heading: HeadingLevel.HEADING_1 
                        }));
                    } else if (element.tagName === 'H2') {
                        children.push(new Paragraph({ 
                            text: element.textContent, 
                            heading: HeadingLevel.HEADING_2 
                        }));
                    } else if (element.tagName === 'H3') {
                        children.push(new Paragraph({ 
                            text: element.textContent, 
                            heading: HeadingLevel.HEADING_3 
                        }));
                    } else if (element.tagName === 'P') {
                        children.push(new Paragraph({ text: element.textContent }));
                    } else if (element.tagName === 'UL' || element.tagName === 'OL') {
                        const listItems = element.querySelectorAll('li');
                        listItems.forEach(item => {
                            children.push(new Paragraph({ 
                                text: `‚Ä¢ ${item.textContent}`,
                                spacing: { before: 200, after: 200 }
                            }));
                        });
                    } else if (element.tagName === 'STRONG') {
                        children.push(new Paragraph({ 
                            children: [new TextRun({ text: element.textContent, bold: true })]
                        }));
                    } else {
                        children.push(new Paragraph({ text: element.textContent }));
                    }
                }
            } else {
                children.push(new Paragraph({ text: title }));
            }

            const doc = new Document({ sections: [{ properties: {}, children }] });
            const blob = await Packer.toBlob(doc);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${title}.docx`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function exportFolderContent() {
            if (!currentFolder) return;
            const exportData = JSON.parse(JSON.stringify(currentFolder));
            const dataStr = JSON.stringify({ folder: exportData, exportedAt: new Date().toISOString() }, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentFolder.name}-export.json`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        // Navigation functions
        function goBack() {
            window.history.back();
        }

        function goToHome() {
            window.location.href = 'app.html';
        }

        function goToCalendar() {
            window.location.href = 'calendar.html';
        }

        function goToStats() {
            window.location.href = 'stats.html';
        }

        function goToChat() {
            window.location.href = 'chat.html';
        }
    </script>
</body>
</html> 